name: Hibernate Reactive CI

on:
  push:
    branches:
      - wip/mssql
    tags: '*'
  pull_request:
    branches: wip/mssql

jobs:
  test_dbs:
    name: Test with ${{ matrix.db }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        db: [ 'MSSQLServer' ]
        vertx-version: [ '[4.1,4.2)' ]
    steps:
    - uses: actions/checkout@v2
    - name: Get year/month for cache key
      id: get-date
      run: |
        echo "::set-output name=yearmonth::$(/bin/date -u "+%Y-%m")"
      shell: bash
    - name: Cache Gradle downloads
      uses: actions/cache@v2
      id: cache-gradle
      with:
        path: |
          .gradle/caches
          .gradle/jdks
          .gradle/wrapper
        # refresh cache every month to avoid unlimited growth
        key: gradle-db-${{ matrix.db }}-${{ steps.get-date.outputs.yearmonth }}
    - name: Set up JDK 1.8
      uses: actions/setup-java@v1
      with:
        java-version: 1.8
    - name: Print the effective Vert.x version used
      run: ./gradlew :hibernate-reactive-core:dependencyInsight --dependency io.vertx -PvertxVersion='${{ matrix.vertx-version }}' -PenableSonatypeOpenSourceSnapshotsRep
    - name: Build and Test with ${{ matrix.db }}
      run: ./gradlew build -PshowStandardOutput -Pdocker -Pdb=${{ matrix.db }} -PvertxVersion='${{ matrix.vertx-version }}' -PenableSonatypeOpenSourceSnapshotsRep
    - name: Upload reports (if build failed)
      uses: actions/upload-artifact@v2
      if: failure()
      with:
        name: reports-db-${{ matrix.db }}
        path: './**/build/reports/'
