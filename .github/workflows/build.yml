name: Hibernate Reactive CI

on:
  push:
    branches:
      - master
    tags: '*'
  pull_request:
    branches: master

jobs:
  test_postgresql:
    name: Test with PostgreSQL
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Set up JDK 1.8
      uses: actions/setup-java@v1
      with:
        java-version: 1.8
    - name: Build and Test with PostgreSQL
      run: ./gradlew build -Pdocker -Pdb=pg

  test_mysql:      
    name: Test with MySQL
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Set up JDK 1.8
      uses: actions/setup-java@v1
      with:
        java-version: 1.8
    - name: Build and Test with MySQL
      run: ./gradlew build -Pdocker -Pdb=mysql

  test_db2:      
    name: Test with DB2
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Set up JDK 1.8
      uses: actions/setup-java@v1
      with:
        java-version: 1.8
    - name: Build and Test with DB2
      run: ./gradlew build -Pdocker -Pdb=db2

  snapshot:
    name: Create snapshot
    if: github.event_name == 'push' && startsWith( github.ref, 'refs/heads/' )
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Set up JDK 1.8
      uses: actions/setup-java@v1
      with:
        java-version: 1.8
    - name: Create maven package
      run: ./gradlew assemble
    - name: Detect the version of Hibernate Reactive
      id: detect-version
      run: |
        sed -E 's/^projectVersion( *= *| +)([^ ]+)/::set-output name=version::\2/g' gradle/version.properties
    - name: Publish snapshot to JBoss Nexus (experimental, Nexus rejects some binaries)
      env:
        ORG_GRADLE_PROJECT_jbossNexusUser: ${{ secrets.jbossNexusUser }}
        ORG_GRADLE_PROJECT_jbossNexusPassword: ${{ secrets.jbossNexusPassword }}
      if: endsWith( steps.detect-version.outputs.version, '-SNAPSHOT' ) && env.ORG_GRADLE_PROJECT_jbossNexusUser
      run: ./gradlew publish
      
  release:
    name: Release
    if: github.event_name == 'push' && startsWith( github.ref, 'refs/tags/' )
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Set up JDK 1.8
      uses: actions/setup-java@v1
      with:
        java-version: 1.8
    - name: Create maven package
      run: ./gradlew assemble
    - name: Publish release to Bintray
      env:
        ORG_GRADLE_PROJECT_bintrayUser: ${{ secrets.bintrayUser }}
        ORG_GRADLE_PROJECT_bintrayKey: ${{ secrets.bintrayKey }}
      run: ./gradlew bintrayUpload
